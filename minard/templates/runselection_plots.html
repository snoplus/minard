{% extends "layout.html" %}
{% block title %}Run Selection Plots{% endblock %}
{% block head %}
    <!-- metrics-graphics stylesheet goes above super() because we want bootstrap's style
    (which is linked in super()) to override it. -->
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static',filename='css/metricsgraphics.css') }}">
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static',filename='css/mg_line_brushing.css') }}">
  {{ super() }}
  <style>
    .btn2 {
        background-color: #228B22;
        padding: 6px 6px;
        color: white;
        text-align: center;
        font-size: 14px;
        margin: 4px 2px;
        cursor: pointer;
    }
  </style>
{% endblock %}
{% block body %}
    {{ super() }}

    <div class="page-header">
        <h1 align="center">Run Selection Plots</h1>
    </div>

    <!-- Set up display options -->
    <div class="container">
        <div class="col-md-12">
            <table class="table table-hover">
                <tr>
                    <th> Date Range: </th>
                    <th> Criteria: </th>
                    <th> </th>
                </tr>
                <tr>
                    <!-- Run date inputs -->
                    <th>
                        <input style="margin-bottom: 30px;" type="date" id="date_low" value={{date_low}} required></input>
                        -
                        <input style="margin-bottom: 30px;" type="date" id="date_high" value={{date_high}} required></input>
                    </th>
                    <!-- Criteria drop-down -->
                    <th>
                        <select id="crit">
                        <option selected value="{{criteria}}">{{criteria}}</option>
                        {% for n in drop_down_crits %}
                            {% if n != criteria %}
                                <option value="{{n}}">{{n}}</option>
                            {% endif %}
                        {% endfor %}
                        </select>
                    </th>
                    <!-- Button to update plots with the run dates & criteria -->
                    <th class="col-xs-3 col-xs-offset-0">
                        <button type=button onclick="history();">Update Plot</button>
                    </th>
                </tr>
            </table>
    <!-- Runs summary goes here -->
        <div class="row">
            <div class="col-md-12" id="sum">
                <h2 align="left"> Summary: </h2>
                <p id="phys_summary"> </p>
                <p id="pass_summary"> </p>
                <p id="fail_summary"> </p>
                <p id="purg_summary"> </p>
            </div>
        </div>
    <!-- Stacked Filled Area Line Plot -->
        <div class="row">
            <div class="col-md-12">
                <!-- <h3>Cumulative Plot</h3> -->
                <div id="chartContainer" style="height: 500px;">
                    <canvas id="RunSelectionPlot"></canvas>
                </div>
            </div>
        </div>

    <!-- Differential Plot (Bar) -->
        <div class="row" style="margin-top:20px;">
            <div class="col-md-12">
                <!-- <h3>Differential Plot</h3> -->
                <div id="diffChartContainer" style="height: 400px;">
                    <canvas id="RunSelectionDiffPlot"></canvas>
                </div>
            </div>
        </div>
    <!-- Line Plot -->
        <div class="row">
            <div class="col-md-12" id="main">
            {% if not rs_plot_data %}
                <h2 align="left"> No data available </h2>
            {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
    <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/moment-timezone-with-data.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/stream_utilities.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        if (url_params.date_low && document.getElementById("date_low").value == "") {
            document.getElementById("date_low").value = url_params.date_low;
        }
        if (url_params.date_high && document.getElementById("date_high").value == "") {
            document.getElementById("date_high").value = url_params.date_high;
        }
        if (url_params.criteria) {
            document.getElementById("crit").value = url_params.criteria;
        }

        var rs_plot_data = {{ rs_plot_data | safe }};

        var dates = [];
        var pass_cumulative = [];
        var fail_cumulative = [];
        var purg_cumulative = [];
        var idle_cumulative = [];
        
        var pass_incremental = [];
        var fail_incremental = [];
        var purg_incremental = [];
        var idle_incremental = [];

        // Process hourly data to build cumulative and incremental arrays
        var cumulative_pass = 0;
        var cumulative_fail = 0;
        var cumulative_purg = 0;
        var cumulative_idle = 0;

        for (var i = 0; i < rs_plot_data.length; i++)
        {
            var date_ = moment(rs_plot_data[i]['timestamp']).toDate();
            dates.push(date_);
            
            // Get incremental values (hours in this specific hour)
            var pass_inc = rs_plot_data[i]['pass_time'] || 0;
            var fail_inc = rs_plot_data[i]['fail_time'] || 0;
            var purg_inc = rs_plot_data[i]['purg_time'] || 0;
            var idle_inc = rs_plot_data[i]['idle_time'] || 0;
            
            pass_incremental.push(pass_inc);
            fail_incremental.push(fail_inc);
            purg_incremental.push(purg_inc);
            idle_incremental.push(idle_inc);
            
            // Build cumulative values
            cumulative_pass += pass_inc;
            cumulative_fail += fail_inc;
            cumulative_purg += purg_inc;
            cumulative_idle += idle_inc;
            
            pass_cumulative.push(cumulative_pass);
            fail_cumulative.push(cumulative_fail);
            purg_cumulative.push(cumulative_purg);
            idle_cumulative.push(cumulative_idle);
        }

        // Summary - use final cumulative values
        var total_pass = cumulative_pass;
        var total_fail = cumulative_fail;
        var total_purg = cumulative_purg;
        var total_idle = cumulative_idle;
        var total_phys = total_pass + total_fail + total_purg;

        document.getElementById("phys_summary").innerHTML = 'Physics: ' + total_phys.toFixed(2) + ' Hours';
        document.getElementById("pass_summary").innerHTML = 'Passed: ' + total_pass.toFixed(2) + ' Hours';
        document.getElementById("fail_summary").innerHTML = 'Failed: ' + total_fail.toFixed(2) + ' Hours';
        document.getElementById("purg_summary").innerHTML = 'Purgatory: ' + total_purg.toFixed(2) + ' Hours';

        // Stacked Filled Area Line Plot using Chart.js
        var ctx = document.getElementById('RunSelectionPlot').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates.map(d => moment(d).format('MM-DD HH:mm')),
                datasets: [
                    {
                        label: 'Passed',
                        data: pass_cumulative,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0,
                        fill: 'origin'
                    },
                    {
                        label: 'Failed',
                        data: fail_cumulative,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0,
                        fill: '-1'
                    },
                    {
                        label: 'Purgatory',
                        data: purg_cumulative,
                        borderColor: 'rgb(255, 206, 86)',
                        backgroundColor: 'rgba(255, 206, 86, 0.5)',
                        borderWidth: 2,
                        tension: 0.1,
                        pointRadius: 0,
                        fill: '-1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 0
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { font: { size: 14, weight: 'bold'}}
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': ' + Number(ctx.parsed.y).toFixed(2) + ' hours';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        title: { display: true, text: 'Cumulative Datahours', font: { size: 14 } },
                        ticks: {
                            font: { size: 12 },
                            padding: 5,
                            callback: function(v) { return Number(v).toFixed(2); }
                        },
                        afterFit: function(scaleInstance) {
                            scaleInstance.width = 100;
                        }
                    },
                    x: {
                        display: false
                    }
                }
            }
        });

        // Differential (time per interval) chart
        var ctx2 = document.getElementById('RunSelectionDiffPlot').getContext('2d');
        var diffChart = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: dates.map(d => moment(d).format('MM-DD HH:mm')),
                datasets: [
                    {
                        label: 'Passed',
                        data: pass_incremental,
                        backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1,
                        stack: 'runs'
                    },
                    {
                        label: 'Failed',
                        data: fail_incremental,
                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1,
                        stack: 'runs'
                    },
                    {
                        label: 'Purgatory',
                        data: purg_incremental,
                        backgroundColor: 'rgba(255, 206, 86, 0.5)',
                        borderColor: 'rgb(255, 206, 86)',
                        borderWidth: 1,
                        stack: 'runs'
                    },
                    {
                        label: 'Idle',
                        data: idle_incremental,
                        backgroundColor: 'rgba(200, 200, 200, 0.3)',
                        borderColor: 'rgb(150, 150, 150)',
                        borderWidth: 1,
                        stack: 'runs'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        left: 0
                    }
                },
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { font: { size: 14, weight: 'bold'}}
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': ' + Number(ctx.parsed.y).toFixed(3) + ' hours';
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        stacked: true, 
                        title: { display: true, text: 'Date', font: { size: 14 } }, 
                        ticks: { maxRotation: 45, minRotation: 45, font: { size: 11 } } 
                    },
                    y: { 
                        stacked: true, 
                        beginAtZero: true,
                        max: 1.0,
                        title: { display: true, text: 'Incremental Datahours', font: { size: 14 } }, 
                        ticks: { 
                            font: { size: 12 }, 
                            padding: 5,
                            callback: function(v) { return Number(v).toFixed(2); }
                        },
                        afterFit: function(scaleInstance) {
                            scaleInstance.width = 100;
                        }
                    }
                }
            }
        });

        function history() {
            var params = {};

            var oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            var defaultLow = oneWeekAgo.toISOString().split('T')[0];

            var today = new Date();
            var defaultHigh = today.toISOString().split('T')[0];

            try { params['date_low'] = document.getElementById("date_low").value; } catch(e) { params['date_low'] = defaultLow; }
            try { params['date_high'] = document.getElementById("date_high").value; } catch(e) { params['date_high'] = defaultHigh; }
            try { params['criteria'] = document.getElementById("crit").value; } catch(e) { params['criteria'] = 'scintillator'; }
            window.location.replace($SCRIPT_ROOT + "/runselection_plots?" + $.param(params));
        }
    </script>
{% endblock %}
