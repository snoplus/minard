{% extends "layout.html" %}
{% block title %}Slow Control Plots{% endblock %}
{% block head %}
    <!-- metrics-graphics stylesheet goes above super() because we want bootstrap's style
    (which is linked in super()) to override it. -->
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static',filename='css/metricsgraphics.css') }}">
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static',filename='css/mg_line_brushing.css') }}">
  {{ super() }}
{% endblock %}
{% block body %}
    {{ super() }}

    <div class="page-header">
        <h1 align="center">Slow Control Plots</h1>
    </div>

    <!-- Set up display options -->
    <div class="container">
            <table class="table">
            <tr>
                <th> Date Range </th>
                <th> Datastream </th>
                <th> Plot Actions </th>
                <th> Plot Controls 
                    <button style="margin-left:0.5em; {% if not slow_data %} visibility:hidden {% endif %}" disabled 
                    id="update-plot" onclick="updatePlot()">Update</button> 
                </th>
            </tr>
            <tr>
                <!-- Data datetime inputs -->
                <th class="col-md-2">
                    <div>
                        <input style="margin-bottom: 10px;" type="datetime-local" id="datetime_low" value="{{datetime_low}}" required></input> 
                    </div>
                    <div>
                        <input style="margin-bottom: 10px;" type="datetime-local" id="datetime_high" value="{{datetime_high}}" required></input>
                    </div>
                    <div id="date-warning" style="color:red; visibility:hidden">Clear the plot to unlock dates.</div>
                </th>
                <!-- Channel selector -->
                <th class="col-md-5">
                    <table style="border-spacing:0 0em; border-collapse:separate">
                        <tr>
                            <th class="col-md-4" style="padding-right:2em">
                                <label for="supply">Supply Voltage</label>
                                <input type="radio" id="supply" value="supply" name="channel-type" style="float:right">
                            </th>
                            <th class="col-md-3">
                                <label for="supply-rack">Rack #</label>
                                <select name="supply-rack" id="supply-rack">
                                    <option disabled selected hidden>...</option>
                                    <option value="1">Rack 1</option>
                                    <option value="2">Rack 2</option>
                                    <option value="3">Rack 3</option>
                                    <option value="4">Rack 4</option>
                                    <option value="5">Rack 5</option>
                                    <option value="6">Rack 6</option>
                                    <option value="7">Rack 7</option>
                                    <option value="8">Rack 8</option>
                                    <option value="9">Rack 9</option>
                                    <option value="10">Rack 10</option>
                                    <option value="11">Rack 11</option>
                                    <option value="timing">Timing Rack</option>
                                </select>
                            </th>
                            <th class="col-md-3">
                                <label for="supply-voltage">Voltage</label>
                                <select name="supply-voltage" id="supply-voltage">
                                    <option disabled selected hidden id="default-voltage">...</option>
                                    <option value="24">24V</option>
                                    <option value="-24">-24V</option>
                                    <option value="8" id="supply-flippy">8V</option>
                                    <option value="5">5V</option>
                                    <option value="-5">-5V</option>
                                    <option value="mtcd" id="mtcd" hidden>MTCD 2V</option>
                                </select>
                            </th>
                        </tr>
                        <tr>
                            <th class="col-md-4" style="padding-right:2em">
                                <label for="baseline">Baseline Voltage</label>
                                <input type="radio" id="baseline" value="baseline" name="channel-type" style="float:right">
                            </th>
                            <th class="col-md-3">
                                <label for="baseline-crate">Crate #</label>
                                <select name="baseline-crate" id="baseline-crate">
                                    <option disabled selected hidden>...</option>
                                    <option value="0">Crate 0</option>
                                    <option value="1">Crate 1</option>
                                    <option value="2">Crate 2</option>
                                    <option value="3">Crate 3</option>
                                    <option value="4">Crate 4</option>
                                    <option value="5">Crate 5</option>
                                    <option value="6">Crate 6</option>
                                    <option value="7">Crate 7</option>
                                    <option value="8">Crate 8</option>
                                    <option value="9">Crate 9</option>
                                    <option value="10">Crate 10</option>
                                    <option value="11">Crate 11</option>
                                    <option value="12">Crate 12</option>
                                    <option value="13">Crate 13</option>
                                    <option value="14">Crate 14</option>
                                    <option value="15">Crate 15</option>
                                    <option value="16">Crate 16</option>
                                    <option value="17">Crate 17</option>
                                    <option value="18">Crate 18</option>
                                </select>
                            </th>
                            <th class="col-md-3">
                                <label for="baseline-trigger">Trigger</label>
                                <select name="baseline-trigger" id="baseline-trigger">
                                    <option disabled selected hidden>...</option>
                                    <option value="100">N100_BL</option>
                                    <option value="20">N20_BL</option>
                                </select>
                            </th>
                        </tr>
                    </table>
                </th>
                <!-- Plot actions -->
                <th class="col-md-2">
                    <div style="padding-bottom:0.5em"> <button type=button id="new-plot" onclick="historyNew();">Generate New Plot</button> </div>
                    <div style="padding-bottom:0.5em"> <button type=button id="append-plot" onclick="historyAppend();">Add To Plot</button> </div>
                    <div> <button type=button id="append-plot" onclick="historyClear();">Clear Plot</button> </div>
                    <div id="mismatch-warning" style="color:red; padding-top:0.6em; visibility:hidden">Datastream types must match.</div>
                </th>
                <!-- Plot controls -->
                <th id="plot-controls-layer-1" class="col-md-2"> <!-- this and child used to disable when no data -->
                    <div id="plot-controls-layer-2"> <!-- cannot be done using jinja template, as python only sends NEW data (stateless) :( -->
                        <div> <input type=checkbox id="y-max-check"> Override Max </input> <input type="number" id="y-max-value" step="0.1" style="width:4em" disabled> </div>
                        <div> <input type=checkbox id="y-min-check"> Override Min </input> <input type="number" id="y-min-value" step="0.1" style="width:4em" disabled> </div>
                        <div> <input type="radio" id="y-axis-relative" value="relative" name="y-axis-type" checked> <label for="axis-relative">Relative Default Range</label> </div>
                        <div> <input type="radio" id="y-axis-absolute" value="absolute" name="y-axis-type"> <label for="axis-absolute">Absolute Default Range</label> </div>
                    </div>
                </th>
            </tr>
            </table>
        <div class="row">
            <div class="col-md-12" id="sum">
                <div id="waiting" {% if not slow_data %} hidden {% endif %}>
                    Received data, loading...
                </div>
                <div id="incompatible" style="color:red" hidden>
                    Data was incompatible. This should never happen.
                </div>
            </div>
        </div>
    <!-- Plot goes here -->
        <div class="row">
            <div class="col-md-12" id="main">
                <h2 align="left" id="data-status"> No data </h2>
            </div>
        </div>

        <div class="row" id="datastreams-listing-container">
            <div class="col-md-12">
                <h2 align="left"> Available Data </h2>
                <table class="table table-hover" id="datastreams-listing">
                    <thead>
                        <tr>
                        <th>Index</th>
                        <th>Datastream</th>
                        <th>Start time</th>
                        <th>End time</th>
                        <th>Points</th>
                        <th>Operations</th>
                        </tr>
                    </thead>
                    <tbody id="datastreams-body">
                    </tbody>
                </table>
            </div>
        </div>

    </div>

<style>
    .mg-line1-legend-color {color: #88D642; fill: #88D642;} 
    .mg-line1-color {stroke: #88D642;}
    .mg-hover-line1-color {fill: #88D642;}
    .mg-area1-color {fill: #88D642;}

    .mg-line2-legend-color {color: #FF79C0; fill: #FF79C0;}
    .mg-line2-color {stroke: #FF79C0;}
    .mg-hover-line2-color {fill: #FF79C0;}
    .mg-area2-color {fill: #FF79C0;}

    .mg-line3-legend-color {color: #60c1bf; fill: #60c1bf;}
    .mg-line3-color {stroke: #60c1bf;}
    .mg-hover-line3-color {fill: #60c1bf;}
    .mg-area3-color {fill: #60c1bf;}

    .mg-line4-legend-color {color: #f8b128; fill: #f8b128;}
    .mg-line4-color {stroke: #f8b128;}
    .mg-hover-line4-color {fill: #f8b128;}
    .mg-area4-color {fill: #f8b128;}

    .mg-line5-legend-color {color: #5c5c5c; fill: #5c5c5c;}    
    .mg-line5-color {stroke: #5c5c5c;}
    .mg-hover-line5-color {fill: #5c5c5c;}
    .mg-area5-color {fill: #5c5c5c;}

    .mg-line6-legend-color {color: #0101d4; fill: #0101d4;}    
    .mg-line6-color {stroke: #0101d4;}
    .mg-hover-line6-color {fill: #0101d4;}
    .mg-area6-color {fill: #0101d4;}
</style>

{% endblock %}

{% block script %}
    <script src="{{ url_for('static', filename='js/d3.js') }}"></script>
    <script src="{{ url_for('static', filename='js/moment.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/moment-timezone-with-data.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tzscale.js') }}"></script>
    <script src="{{ url_for('static', filename='js/metricsgraphics.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mg_line_brushing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/stream_utilities.js') }}"></script>
    <script src="{{ url_for('static', filename='js/slowcontrol_plots.js') }}"></script>
    <script>

        const datetimeLowInput = document.getElementById("datetime_low");
        const datetimeHighInput = document.getElementById("datetime_high");
        const dateWarningText = document.getElementById("date-warning");

        if (url_params.datetime_low && datetimeLowInput.value == "") {
            datetimeLowInput.value = url_params.datetime_low;
        }
        if (url_params.datetime_high && datetimeHighInput.value == "") {
            datetimeHighInput.value = url_params.datetime_high;
        }
        if (url_params.channel_type) {
            document.getElementById(url_params.channel_type).checked = true 
        }

        function initializeStoredArray(name) {
            rawValue = sessionStorage.getItem(name)
            if ((typeof rawValue !== "undefined") && (rawValue !== null))  { //probably only need "null" 
                return JSON.parse(rawValue)
            }
            else {
                return []
            }
        }

        function storeArray(name, data) {
            return sessionStorage.setItem(name, JSON.stringify(data));
        }

        var newSlowData = {{ slow_data | safe if slow_data is not none else "null" }}; //yes it's lowercase, because jinja none (not python None)
        var newDataName = "{{ data_name | safe if data_name is not none else "null" }}"; // this sucks i am so sorry
        var newBaseRange = {{ base_range | safe if base_range is not none else "null" }};

        var slowData = initializeStoredArray("storedSlowData")
        var dataNames = initializeStoredArray("storedDataNames")
        var baseRanges = initializeStoredArray("storedBaseRanges")
        var dataType = sessionStorage.getItem("dataType");
        var plotControlsState = JSON.parse(sessionStorage.getItem("storedPlotControls"))

        if (newSlowData !== null && newSlowData.length > 0) { //unfortunate, but null handling is hard
            slowData.push(newSlowData)
        }
        if (newDataName !== "null") { //more unfortunate
            dataNames.push(newDataName)
        }
        if (newBaseRange !== null && !baseRanges.includes(newBaseRange)) {
            baseRanges.push(newBaseRange)
        }

        if (plotControlsState !== null) {
            yMaxCheckbox.checked = plotControlsState["yMaxOn"];
            yMinCheckbox.checked = plotControlsState["yMinOn"];
            yMaxValueEntry.value = plotControlsState["yMaxVal"];
            yMinValueEntry.value = plotControlsState["yMinVal"];
            if (plotControlsState["yAxisMode"] === "relative") {
                relativeRadio.checked = true;
            }
            else if (plotControlsState["yAxisMode"] === "absolute") {
                absoluteRadio.checked = true;
            }
        }

        var mergedData = [];

        if (slowData.length > 0) {
            document.getElementById("data-status").innerHTML = "Data recieved, loading...";

            slowData.forEach((datastream) => {
                // if (datastream.length !== slowData[0].length) {
                //     document.getElementById("incompatible").removeAttribute("hidden")
                //     throw new Error("Data streams were incompatible.");
                // }
                if (typeof datastream[0].key == "string") {
                    datastream.forEach((datapoint) => {
                        datapoint['key'] = moment(datapoint['key']).toDate();
                    });
                }
                if (typeof datastream[0].key == "number") {
                    datastream.forEach((datapoint) => {
                        datapoint['key'] = moment.unix(datapoint['key']).toDate();
                    });
                }
            });

            mintime = slowData[0][0]['key'];
            maxtime = slowData[0][slowData[0].length-1]['key'];
            var cscale = tzscale().domain([mintime, maxtime]).zone('America/Toronto');
        }
        else {
            document.getElementById("datastreams-listing-container").remove();
            var plotControlsLayer1 = document.getElementById("plot-controls-layer-1");
            plotControlsLayer1.title = "No data. Add data to the plot to enable controls.";
            var plotControlsLayer2 = document.getElementById("plot-controls-layer-2");
            plotControlsLayer2.style.pointerEvents = "none";
            plotControlsLayer2.style.opacity = "33.3%"; 
        }

        var time_fmt = 'MMMM Do YYYY, h:mm:ss a';
        
        function getMaxY() {
            try {
                if (yMaxCheckbox.checked) { 
                    return yMaxValueEntry.value; 
                }
                else {
                    var axisMode = document.querySelector("input[name=y-axis-type]:checked").value;
                    if (axisMode === relativeRadio.value) { 
                        return (Math.max(...baseRanges) * 1.1) + 1; 
                    }
                    else if (axisMode === absoluteRadio.value) { 
                        return null; 
                    }
                }
            }
            finally { //if error, checkbox does not exist
                return null; //if exists but no condition hit, return null
            }
        }
        
        function getMinY() {
            try {
                if (yMinCheckbox.checked) { 
                    return yMinValueEntry.value;
                }
                else {
                    var axisMode = document.querySelector("input[name=y-axis-type]:checked").value;
                    if (axisMode === relativeRadio.value) { 
                        const val = (Math.min(...baseRanges) - (0.1 * Math.abs(Math.min(...baseRanges)))) - 1;
                        console.log(`using relative: ${val}`);
                        return val;
                    }
                    else if (axisMode === absoluteRadio.value) { 
                        console.log("using absolute")
                        return null;
                    }
                }
            }
            finally {
                return null;
            }
        }

        function wgetMinY() {
            var y = getMinY();
            console.log(`min y: ${y}`);
            return y;
        }

        function updatePlot() {
            var dparams = {
                area: false,
                data: slowData,
                width: $('#main').width(),
                left: 100,
                right: 100,
                height: 500,
                target: "#main",
                time_scale: cscale,
                animate_on_load: true,
                x_accessor:'key',
                y_accessor:'value',
                point_size: 4.0,
                x_label: "Time",
                y_label: "Voltage",
                max_y: getMaxY(),
                min_y: wgetMinY(), 
                baselines: baseRanges.map(function(baseline, index) {
                        return {"value": baseline, "label": `${baseline}V`};
                    }),
                decimals: 4,
                legend: dataNames,
                interpolate: 'linear',

                y_mouseover: function(data) {
                    var voltage = parseFloat(data['value']).toFixed(4);
                    return voltage + ' V' ;
                },

                x_mouseover: function(data) {
                    return moment(data.key).format(time_fmt);
                }
            };

            initialPlotState = getPlotControlsState();
            sessionStorage.setItem("storedPlotControls", JSON.stringify(initialPlotState));
            updateButton.setAttribute("disabled", "");

            if (slowData.length > 0) {
                MG.data_graphic(dparams); //replaces "No data" text
                try {
                    document.getElementById("data-status").remove();
                }
                catch { 
                    console.log("testing!")
                } //if it already doesn't exist, just continue
            }

            // the only way to change line width, i tried. ugh
            // changing dparams or overriding CSS did NOT work, for me at least
            // needs to be in here to update new lines
            document.querySelectorAll('#main svg path.mg-main-line').forEach(function(path) {
                path.style.strokeWidth = '1.5px';
            });
            document.querySelectorAll('#main svg .mg-line-legend text').forEach(function(text) {
                text.style.fontSize = '1.2em';
                text.style.fontWeight = '600';
            });
            document.querySelectorAll('.mg-x-axis text, .mg-y-axis text, .mg-histogram .axis text').forEach(function(text) {
                text.style.fontSize = '1.1em';
            });

            return dparams;
        }

        function deleteStream(index) {
            slowData.splice(index, 1);
            storeArray("storedSlowData", slowData);
            dataNames.splice(index, 1);
            storeArray("storedDataNames", dataNames);
            sessionStorage.setItem("dataType", document.querySelector("input[name=channel-type]:checked").value);

            window.location.replace($SCRIPT_ROOT + "/slowcontrol_plots");
        }

        function addDatastreamTableRow(name, first, last, length, index) {
            tableData=
            `<tr>
                    <td class="mg-line${index+1}-legend-color">${index+1}</td>
                    <td>${name}</td>
                    <td>${first}</td>
                    <td>${last}</td>
                    <td>${length}</td>
                    <td><button onclick="deleteStream(${index})">Remove</button></td>
                    </tr>`;
            var newRow = document.getElementById("datastreams-listing").insertRow();
            newRow.innerHTML = tableData;
            return true;
        } //would really rather put these in the .js, but alas...

        for (var i = 0; i < slowData.length; i++) {
            var streamLength = slowData[i].length;
            var myName = dataNames[i];
            var myFirstTime = moment(slowData[i][0].key).format(time_fmt);
            var myLastTime = moment(slowData[i][streamLength-1].key).format(time_fmt);
            addDatastreamTableRow(myName, myFirstTime, myLastTime, streamLength, i);
        }
        
        document.getElementById("waiting").setAttribute("hidden", "")

        if (slowData.length !== 0) {
            datetimeLowInput.setAttribute("disabled", "");
            datetimeHighInput.setAttribute("disabled", "");
            dateWarningText.style.visibility = "visible";
        } else {
            dateWarningText.style.visibility = "hidden";
        }

        function history() {
            var params = {};
            
            sessionStorage.setItem("dataType", document.querySelector("input[name=channel-type]:checked").value);
            appendPlotButton.setAttribute("disabled", "");
            newPlotButton.setAttribute("disabled", "");

            // if timestamp bounds exist for past data, continue
            // otherwise, set them, based on the value of the picker
            // on error, set them to a default fallback value
            // in either case, set the parameter to this stored value
            try {
                if (sessionStorage.getItem("startTimestamp") === null) {
                    sessionStorage.setItem("startTimestamp", datetimeLowInput.value);
                }
            } catch (e) {
                sessionStorage.setItem("startTimestamp", "2024-02-19T00:00");
            } finally {
                params['datetime_low'] = sessionStorage.getItem("startTimestamp")
            }
            try {
                if (sessionStorage.getItem("endTimestamp") === null) {
                    sessionStorage.setItem("endTimestamp", datetimeHighInput.value);
                }
                params['datetime_high'] = sessionStorage.getItem("endTimestamp")
            } catch (e) {
                sessionStorage.setItem("endTimestamp", "2024-05-29T23:59");
            } finally {
                params['datetime_high'] = sessionStorage.getItem("endTimestamp")
            }

            // set all other parameters (simply query the input, or fall back on a default)
            try {
                params['channel_type'] = document.querySelector("input[name=channel-type]:checked").value;
            } catch (e) {
                //pass? there's no good default here
            }
            try {
                params['supply_rack'] = document.getElementById("supply-rack").value;
            } catch (e) {
                params['supply_rack'] = "1";
            }
            try {
                params['supply_voltage'] = document.getElementById("supply-voltage").value;
            } catch (e) {
                params['supply_voltage'] = "24";
            }
            try {
                params['baseline_crate'] = document.getElementById("baseline-crate").value;
            } catch (e) {
                params['baseline_crate'] = "0";
            }
            try {
                params['baseline_trigger'] = document.getElementById("baseline-trigger").value;
            } catch (e) {
                params['baseline_trigger'] = "100";
            }

            window.location.replace($SCRIPT_ROOT + "/slowcontrol_plots?" + $.param(params));
        }

        function getEstTimeString() {
            var millisecondDifference = moment(datetimeHighInput.value) - moment(datetimeLowInput.value);
            const DataMsPerMsQueryTime = 400000; //ie. 1 ms of query time returns ~80 results, or 400secs of data (when threaded)
            var estWaitTimeMs = millisecondDifference / DataMsPerMsQueryTime;
            return moment.duration(estWaitTimeMs).locale('en').humanize(); 
        }

        function historyAppend() {
            storeArray("storedSlowData", slowData);
            storeArray("storedDataNames", dataNames);
            storeArray("storedBaseRanges", baseRanges);
            sessionStorage.setItem("storedPlotControls", JSON.stringify(getPlotControlsState()));
            appendPlotButton.innerHTML = `Est. wait: ${getEstTimeString()}`;
            history();
        }
        
        function historyNew() {
            sessionStorage.clear();
            newPlotButton.innerHTML = `Est. wait: ${getEstTimeString()}`;
            history();
        }

        function historyClear() {
            sessionStorage.clear();
            window.location.replace($SCRIPT_ROOT + "/slowcontrol_plots");
        }

        updatePlot();

    </script>
{% endblock %}
